using System;
using System.Collections.Generic;
using System.Net.Http;
using System.Net.Http.Headers;
using Newtonsoft.Json.Linq;

// Define the URL for the Dynamics 365 instance
string instanceUrl = "https://org.crm.dynamics.com";

// Define the version of the Web API to use
string webApiVersion = "v9.2";

// Define the URL for the organizations endpoint
string organizationsUrl = $"{instanceUrl}/api/data/{webApiVersion}/organizations";

// Define the HTTP client and headers
var httpClient = new HttpClient();
httpClient.DefaultRequestHeaders.Authorization = new AuthenticationHeaderValue("Bearer", "{access_token}");
httpClient.DefaultRequestHeaders.Accept.Add(new MediaTypeWithQualityHeaderValue("application/json"));

// Send the request to retrieve the list of organizations
var response = httpClient.GetAsync(organizationsUrl).Result;

// Parse the response as a JSON array
var organizationsArray = JArray.Parse(response.Content.ReadAsStringAsync().Result);

// Print the URL of each organization to the console
foreach (var organization in organizationsArray)
{
    string friendlyName = (string)organization["FriendlyName"];
    string organizationUrl = (string)organization["Endpoints"]["WebApplication"];
    Console.WriteLine($"Friendly Name: {friendlyName}");
    Console.WriteLine($"URL: {organizationUrl}");
}
